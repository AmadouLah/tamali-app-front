<div class="admin-dashboard-container min-h-screen relative overflow-x-hidden" data-theme="liquidGlace">
  <div class="liquid-gradient fixed inset-0 -z-10"></div>
  <div class="fixed inset-0 -z-10 bg-gradient-to-br from-slate-900/90 via-purple-900/80 to-slate-900/90"></div>
  <div class="geometric-shapes">
    <div class="shape shape-1"></div>
    <div class="shape shape-2"></div>
    <div class="shape shape-3"></div>
  </div>

  <app-admin-sidebar
    [menuItems]="menuItems"
    [activeMenu]="activeMenu"
    [mobileOpen]="sidebarOpen"
    (mobileOpenChange)="sidebarOpen = $event"
    (menuClick)="setActiveMenu($event)"
  ></app-admin-sidebar>

  <div class="dashboard-main">
    <header class="glass-effect-strong border-b border-white/20 dashboard-header sticky top-0 z-30">
      <button type="button" class="lg:hidden shrink-0 p-2 rounded-lg glass-effect-subtle border border-white/20 text-white hover:bg-white/10 transition-colors" (click)="sidebarOpen = !sidebarOpen" aria-label="Ouvrir le menu">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
      </button>
      <div class="flex-1 min-w-0 flex items-center gap-3">
        <span class="text-white font-semibold text-sm sm:text-base">Tableau de bord Super Admin</span>
        <button
          type="button"
          (click)="refreshData()"
          [disabled]="refreshing"
          class="flex items-center gap-2 px-3 py-1.5 rounded-lg border border-white/30 text-white text-sm font-medium hover:bg-white/10 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          title="Actualiser les données"
        >
          <svg class="w-4 h-4" [class.animate-spin]="refreshing" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          {{ refreshing ? 'Actualisation...' : 'Actualiser' }}
        </button>
      </div>
      <div class="flex items-center gap-2 md:gap-4 shrink-0">
        <div class="text-right hidden sm:block">
          <div class="text-xs sm:text-sm font-semibold text-white truncate max-w-[120px] md:max-w-none">{{ getUserDisplayName() }}</div>
          <div class="text-xs text-gray-300">Super Admin</div>
        </div>
        <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center text-white font-semibold text-xs sm:text-sm">{{ getUserInitials() }}</div>
      </div>
    </header>

    <main class="dashboard-content">
      @if (error) {
        <div class="mb-4 p-3 bg-red-500/20 border border-red-500/50 rounded-lg text-red-200 text-sm">{{ error }}</div>
      }

      @if (loading && !dashboard) {
        <div class="text-center py-12 text-gray-400">Chargement du tableau de bord...</div>
      } @else if (dashboard) {
        <!-- 1. Vue globale plateforme -->
        <section class="mb-8">
          <h2 class="text-lg font-bold text-white mb-4">Vue globale plateforme</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
            <app-glass-card variant="default" class="p-4 sm:p-5">
              <h3 class="text-xs font-medium text-gray-300 mb-1">Entreprises inscrites</h3>
              <p class="text-2xl font-bold text-white">{{ dashboard.platformStats.totalBusinesses }}</p>
            </app-glass-card>
            <app-glass-card variant="default" class="p-4 sm:p-5">
              <h3 class="text-xs font-medium text-gray-300 mb-1">Utilisateurs</h3>
              <p class="text-2xl font-bold text-white">{{ dashboard.platformStats.totalUsers }}</p>
            </app-glass-card>
            <app-glass-card variant="default" class="p-4 sm:p-5">
              <h3 class="text-xs font-medium text-gray-300 mb-1">Ventes (global)</h3>
              <p class="text-2xl font-bold text-white">{{ formatVolume(dashboard.platformStats.totalSalesCount) }}</p>
            </app-glass-card>
            <app-glass-card variant="default" class="p-4 sm:p-5">
              <h3 class="text-xs font-medium text-gray-300 mb-1">Volume transactions</h3>
              <p class="text-2xl font-bold text-white">{{ formatVolume(dashboard.platformStats.totalTransactionVolume) }}</p>
            </app-glass-card>
            <app-glass-card variant="default" class="p-4 sm:p-5">
              <h3 class="text-xs font-medium text-gray-300 mb-1">Actives aujourd'hui</h3>
              <p class="text-2xl font-bold text-white">{{ dashboard.platformStats.activeBusinessesToday }}</p>
            </app-glass-card>
          </div>
        </section>

        <!-- 2. Activité récente -->
        <section class="mb-8">
          <h2 class="text-lg font-bold text-white mb-4">Activité récente</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <app-glass-card variant="default" class="p-4">
              <h3 class="text-xs font-medium text-gray-300 mb-1">Nouvelles entreprises (7j)</h3>
              <p class="text-xl font-bold text-white">{{ dashboard.recentActivity.newBusinessesCount }}</p>
            </app-glass-card>
            <app-glass-card variant="default" class="p-4">
              <h3 class="text-xs font-medium text-gray-300 mb-1">Nouveaux utilisateurs (7j)</h3>
              <p class="text-xl font-bold text-white">{{ dashboard.recentActivity.newUsersCount }}</p>
            </app-glass-card>
            <app-glass-card variant="strong" class="p-4 md:col-span-2">
              <h3 class="text-xs font-medium text-gray-300 mb-2">Entreprises les plus actives (30j)</h3>
              @if (dashboard.recentActivity.mostActiveBusinesses.length === 0) {
                <p class="text-gray-400 text-sm">Aucune</p>
              } @else {
                <ul class="space-y-1 text-sm">
                  @for (b of dashboard.recentActivity.mostActiveBusinesses; track b.id) {
                    <li class="text-white flex justify-between"><span class="truncate">{{ b.name }}</span><span class="text-gray-400 shrink-0 ml-2">{{ b.saleCountOrDaysSinceLastSale }} ventes</span></li>
                  }
                </ul>
              }
            </app-glass-card>
          </div>
          <app-glass-card variant="default" class="p-4 mt-4">
            <h3 class="text-xs font-medium text-gray-300 mb-2">Entreprises inactives (aucune vente depuis 30j)</h3>
            @if (dashboard.recentActivity.inactiveBusinesses.length === 0) {
              <p class="text-gray-400 text-sm">Aucune</p>
            } @else {
              <ul class="space-y-1 text-sm">
                @for (b of dashboard.recentActivity.inactiveBusinesses; track b.id) {
                  <li class="text-white flex justify-between"><span class="truncate">{{ b.name }}</span><span class="text-amber-400 shrink-0 ml-2">{{ b.saleCountOrDaysSinceLastSale }} j sans activité</span></li>
                }
              </ul>
            }
          </app-glass-card>
        </section>

        <!-- 3. Statistiques d'utilisation -->
        <section class="mb-8">
          <h2 class="text-lg font-bold text-white mb-4">Statistiques d'utilisation</h2>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <app-glass-card variant="strong" class="p-4 lg:col-span-2">
              <h3 class="text-sm font-medium text-gray-300 mb-3">Ventes par jour (plateforme, 30j)</h3>
              <div class="flex items-end justify-between gap-1 h-32">
                @for (d of dashboard.usageStats.salesPerDay; track d.date) {
                  <div class="flex-1 flex flex-col items-center gap-1">
                    <div class="w-full bg-purple-500 rounded-t min-h-[4px] transition-all" [style.height.%]="getBarHeight(d.count)" title="{{ d.count }} ventes"></div>
                    <span class="text-[10px] text-gray-400 truncate w-full text-center">{{ formatShortDate(d.date) }}</span>
                  </div>
                }
              </div>
            </app-glass-card>
            <app-glass-card variant="strong" class="p-4">
              <h3 class="text-sm font-medium text-gray-300 mb-1">Pic d'activité</h3>
              <p class="text-white font-medium">{{ dashboard.usageStats.peakActivityLabel }}</p>
              <h3 class="text-sm font-medium text-gray-300 mt-3 mb-1">Taux d'utilisation</h3>
              <p class="text-2xl font-bold text-white">{{ dashboard.usageStats.usageRatePercent }}%</p>
              <p class="text-xs text-gray-400">entreprises avec vente sur 30j</p>
            </app-glass-card>
          </div>
        </section>

        <!-- 4. Monitoring système -->
        <section class="mb-8">
          <h2 class="text-lg font-bold text-white mb-4">Monitoring système</h2>
          <app-glass-card variant="strong" class="p-4">
            <div class="flex flex-wrap items-center gap-4">
              <div class="flex items-center gap-2">
                <span class="w-2.5 h-2.5 rounded-full" [class.bg-green-500]="dashboard.systemMonitoring.serverStatus === 'UP'" [class.bg-red-500]="dashboard.systemMonitoring.serverStatus !== 'UP'"></span>
                <span class="text-white font-medium">Serveur : {{ dashboard.systemMonitoring.serverStatus }}</span>
              </div>
              @if (dashboard.systemMonitoring.criticalErrors.length > 0) {
                <div class="text-amber-400 text-sm">Erreurs critiques : {{ dashboard.systemMonitoring.criticalErrors.length }}</div>
              }
              @if (dashboard.systemMonitoring.syncFailures.length > 0) {
                <div class="text-amber-400 text-sm">Échecs sync : {{ dashboard.systemMonitoring.syncFailures.length }}</div>
              }
              @if (dashboard.systemMonitoring.emailOrWhatsAppFailures.length > 0) {
                <div class="text-amber-400 text-sm">Problèmes email/WhatsApp : {{ dashboard.systemMonitoring.emailOrWhatsAppFailures.length }}</div>
              }
              @if (dashboard.systemMonitoring.criticalErrors.length === 0 && dashboard.systemMonitoring.syncFailures.length === 0 && dashboard.systemMonitoring.emailOrWhatsAppFailures.length === 0) {
                <span class="text-gray-400 text-sm">Aucune alerte</span>
              }
            </div>
          </app-glass-card>
        </section>

        <!-- 5. Gestion des entreprises -->
        <section class="mb-8">
          <h2 class="text-lg font-bold text-white mb-4">Gestion des entreprises</h2>
          @if (loadingBusinesses) {
            <p class="text-gray-400 text-sm">Chargement...</p>
          } @else {
            <app-glass-card variant="strong" class="overflow-hidden">
              <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                  <thead class="text-gray-300 border-b border-white/10">
                    <tr>
                      <th class="p-3 font-medium">Nom</th>
                      <th class="p-3 font-medium">Email</th>
                      <th class="p-3 font-medium">Utilisateurs</th>
                      <th class="p-3 font-medium">Statut</th>
                      <th class="p-3 font-medium">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (b of businesses; track b.id) {
                      <tr class="border-b border-white/5 hover:bg-white/5">
                        <td class="p-3 text-white">{{ b.name }}</td>
                        <td class="p-3 text-gray-400">{{ b.email ?? '—' }}</td>
                        <td class="p-3 text-white">{{ b.userCount }}</td>
                        <td class="p-3">
                          @if (b.active) {
                            <span class="px-2 py-0.5 rounded bg-green-500/20 text-green-300 text-xs">Active</span>
                          } @else {
                            <span class="px-2 py-0.5 rounded bg-gray-500/20 text-gray-400 text-xs">Inactive</span>
                          }
                        </td>
                        <td class="p-3 flex flex-wrap gap-2">
                          <button type="button" class="text-xs px-2 py-1 rounded border border-white/30 text-white hover:bg-white/10" (click)="setBusinessActive(b, !b.active)">
                            {{ b.active ? 'Désactiver' : 'Activer' }}
                          </button>
                          <button type="button" class="text-xs px-2 py-1 rounded border border-red-500/50 text-red-300 hover:bg-red-500/20" (click)="deleteBusiness(b)">Supprimer</button>
                        </td>
                      </tr>
                    }
                    @if (businesses.length === 0) {
                      <tr><td colspan="5" class="p-4 text-gray-400 text-center">Aucune entreprise</td></tr>
                    }
                  </tbody>
                </table>
              </div>
            </app-glass-card>
          }
        </section>

        <!-- Demandes de service -->
        <section class="mt-6">
          <app-glass-card variant="strong">
            <div class="p-4 sm:p-6">
              <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-4">
                <h2 class="text-xl font-bold text-white">Demandes de service</h2>
                <button (click)="loadServiceRequests()" class="btn btn-sm btn-primary rounded-full px-4 text-sm w-full sm:w-auto">Actualiser</button>
              </div>
              @if (serviceRequests.length === 0) {
                <p class="text-gray-400 text-sm">Aucune demande.</p>
              } @else {
                <div class="space-y-3">
                  @for (request of serviceRequests; track request.id) {
                    <div class="glass-effect-subtle p-4 rounded-lg border border-white/10">
                      <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3">
                        <div class="flex-1 min-w-0">
                          <p class="font-semibold text-white text-sm">{{ request.email }}</p>
                          @if (request.processed) {
                            <span class="px-2 py-0.5 bg-green-500/20 text-green-300 text-xs rounded-full">Traitée</span>
                          } @else {
                            <span class="px-2 py-0.5 bg-yellow-500/20 text-yellow-300 text-xs rounded-full">En attente</span>
                          }
                          <p class="text-gray-300 text-xs mt-2 break-words">{{ request.objective }}</p>
                          <p class="text-gray-400 text-xs mt-1">Reçue le {{ formatDate(request.createdAt) }}</p>
                        </div>
                        @if (!request.processed) {
                          <button (click)="markAsProcessed(request.id)" class="btn btn-sm btn-primary rounded-full px-4 text-sm shrink-0">Marquer comme traitée</button>
                        }
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          </app-glass-card>
        </section>
      }
    </main>
  </div>
</div>
