<div class="add-business-owner-container min-h-screen relative overflow-x-hidden" data-theme="liquidGlace">
  <!-- Background gradient animé avec formes géométriques -->
  <div class="liquid-gradient fixed inset-0 -z-10"></div>
  <div class="fixed inset-0 -z-10 bg-gradient-to-br from-slate-900/90 via-purple-900/80 to-slate-900/90"></div>
  
  <!-- Formes géométriques flottantes -->
  <div class="geometric-shapes">
    <div class="shape shape-1"></div>
    <div class="shape shape-2"></div>
    <div class="shape shape-3"></div>
  </div>

  <!-- Sidebar -->
  <app-admin-sidebar
    [menuItems]="menuItems"
    [activeMenu]="activeMenu"
    [mobileOpen]="sidebarOpen"
    (mobileOpenChange)="sidebarOpen = $event"
    (menuClick)="activeMenu = $event"
  ></app-admin-sidebar>

  <!-- Main Content -->
  <div class="dashboard-main">
    <!-- Header -->
    <header class="glass-effect-strong border-b border-white/20 dashboard-header sticky top-0 z-30">
      <button
        type="button"
        class="lg:hidden shrink-0 p-2 rounded-lg glass-effect-subtle border border-white/20 text-white hover:bg-white/10 transition-colors"
        (click)="sidebarOpen = !sidebarOpen"
        aria-label="Ouvrir le menu"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
      <div class="min-w-0 flex-1 flex items-center justify-between gap-3">
        <h1 class="text-xl md:text-2xl font-bold text-white uppercase truncate">Gestion des propriétaires</h1>
        <button
          (click)="openCreateModal()"
          class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 text-white font-medium rounded-lg transition-all flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Créer un propriétaire
        </button>
      </div>
    </header>

    <!-- Content -->
    <main class="dashboard-content">
      <app-glass-card variant="strong" class="p-6">
        <!-- Barre de recherche -->
        <div class="mb-6">
          <div class="relative">
            <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <input
              type="text"
              [(ngModel)]="searchQuery"
              (input)="onSearchChange()"
              placeholder="Rechercher un propriétaire..."
              class="w-full pl-10 pr-4 py-2 glass-effect-subtle border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-400/50"
            />
          </div>
        </div>

        <!-- Messages -->
        @if (error) {
          <div class="mb-4 p-4 bg-red-500/20 border border-red-500/50 rounded-lg text-red-200 text-sm">
            {{ error }}
          </div>
        }

        @if (success) {
          <div class="mb-4 p-4 bg-green-500/20 border border-green-500/50 rounded-lg text-green-200 text-sm">
            {{ success }}
          </div>
        }

        <!-- En-têtes du tableau -->
        <div class="grid grid-cols-12 gap-4 px-4 py-3 bg-slate-800/50 rounded-lg mb-2">
          <div class="col-span-4">
            <span class="text-xs font-semibold text-gray-300 uppercase">Nom complet</span>
          </div>
          <div class="col-span-4">
            <span class="text-xs font-semibold text-gray-300 uppercase">Email</span>
          </div>
          <div class="col-span-2">
            <span class="text-xs font-semibold text-gray-300 uppercase">Statut</span>
          </div>
          <div class="col-span-2">
            <span class="text-xs font-semibold text-gray-300 uppercase">Actions</span>
          </div>
        </div>

        <!-- Liste des propriétaires -->
        @if (loading && businessOwners.length === 0) {
          <div class="text-center py-12">
            <p class="text-gray-400">Chargement...</p>
          </div>
        } @else if (filteredOwners.length === 0) {
          <div class="text-center py-12">
            <p class="text-gray-400">Aucun propriétaire trouvé.</p>
          </div>
        } @else {
          <div class="space-y-2">
            @for (owner of filteredOwners; track owner.id) {
              <div class="grid grid-cols-12 gap-4 px-4 py-3 glass-effect-subtle border border-white/10 rounded-lg hover:bg-white/5 transition-all">
                <div class="col-span-4 flex items-center">
                  <span class="text-white">{{ getFullName(owner) }}</span>
                </div>
                <div class="col-span-4 flex items-center">
                  <span class="text-gray-300">{{ owner.email }}</span>
                </div>
                <div class="col-span-2 flex items-center">
                  @if (owner.enabled) {
                    <span class="px-3 py-1 bg-green-500/20 text-green-300 text-xs rounded-full border border-green-500/50">
                      Actif
                    </span>
                  } @else {
                    <span class="px-3 py-1 bg-red-500/20 text-red-300 text-xs rounded-full border border-red-500/50">
                      Inactif
                    </span>
                  }
                  @if (owner.mustChangePassword) {
                    <span class="ml-2 px-2 py-1 bg-orange-500/20 text-orange-300 text-xs rounded border border-orange-500/50">
                      Mot de passe temporaire
                    </span>
                  }
                </div>
                <div class="col-span-2 flex items-center gap-2">
                  <button
                    (click)="openAssociateModal(owner)"
                    [disabled]="loading || !owner.businessId"
                    class="p-2 text-purple-400 hover:bg-purple-500/20 rounded-lg transition-colors disabled:opacity-50"
                    title="Ajouter un associé">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                    </svg>
                  </button>
                  <button
                    (click)="toggleOwnerStatus(owner)"
                    [disabled]="loading"
                    [class.text-orange-400]="!owner.enabled"
                    [class.text-blue-400]="owner.enabled"
                    class="p-2 hover:bg-white/10 rounded-lg transition-colors disabled:opacity-50"
                    [title]="owner.enabled ? 'Désactiver' : 'Activer'">
                    @if (owner.enabled) {
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
                      </svg>
                    } @else {
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                    }
                  </button>
                  <button
                    (click)="deleteOwner(owner)"
                    [disabled]="loading"
                    class="p-2 text-red-400 hover:bg-red-500/20 rounded-lg transition-colors disabled:opacity-50"
                    title="Supprimer">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                  </button>
                </div>
              </div>
              @if (hasAssociates(owner.id)) {
                <div class="col-span-12 mt-2 ml-4 pl-4 border-l-2 border-purple-500/30">
                  <div class="text-xs text-gray-400 mb-2">Associés:</div>
                  <div class="space-y-1">
                    @for (associate of getAssociates(owner.id); track associate.id) {
                      <div class="flex items-center justify-between px-3 py-2 glass-effect-subtle rounded text-sm">
                        <span class="text-gray-300">{{ getFullName(associate) }} ({{ associate.email }})</span>
                        @if (associate.mustChangePassword) {
                          <span class="px-2 py-1 bg-orange-500/20 text-orange-300 text-xs rounded border border-orange-500/50">
                            Mot de passe temporaire
                          </span>
                        }
                      </div>
                    }
                  </div>
                </div>
              }
            }
          </div>
        }
      </app-glass-card>
    </main>
  </div>

  <!-- Modal de création -->
  @if (showCreateModal) {
    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" (click)="closeCreateModal()">
      <app-glass-card variant="strong" class="p-6 max-w-md mx-4 w-full" (click)="$event.stopPropagation()">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-white">Créer un propriétaire</h2>
          <button
            (click)="closeCreateModal()"
            class="text-gray-400 hover:text-white transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <p class="text-gray-300 text-sm mb-6">
          Entrez l'email du propriétaire. Un mot de passe temporaire sera généré et envoyé par email avec un lien de connexion.
        </p>

        <form [formGroup]="form" (ngSubmit)="onSubmit()">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">
                Email du propriétaire <span class="text-red-400">*</span>
              </label>
              <input
                #emailInput
                type="email"
                formControlName="email"
                [class.border-red-500]="isFieldInvalid('email')"
                class="w-full px-4 py-2 glass-effect-subtle border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-400/50"
                placeholder="email@exemple.com"
              />
              @if (isFieldInvalid('email')) {
                <p class="mt-1 text-sm text-red-400">{{ getFieldError('email') }}</p>
              }
            </div>
          </div>

          <div class="flex justify-end gap-4 mt-6">
            <button
              type="button"
              (click)="closeCreateModal()"
              [disabled]="loading"
              class="px-6 py-2 border-2 border-white/30 text-white rounded-lg font-medium hover:bg-white/10 transition-colors disabled:opacity-50">
              Annuler
            </button>
            <button
              type="submit"
              [disabled]="loading || form.invalid"
              class="px-6 py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed">
              @if (loading) {
                <span class="flex items-center gap-2">
                  <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  Création...
                </span>
              } @else {
                Créer
              }
            </button>
          </div>
        </form>
      </app-glass-card>
    </div>
  }

  <!-- Modal d'ajout d'associé -->
  @if (showAssociateModal && selectedOwnerId) {
    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" (click)="closeAssociateModal()">
      <app-glass-card variant="strong" class="p-6 max-w-md mx-4 w-full" (click)="$event.stopPropagation()">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-white">Ajouter un associé</h2>
          <button
            (click)="closeAssociateModal()"
            class="text-gray-400 hover:text-white transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <p class="text-gray-300 text-sm mb-6">
          Entrez l'email de l'associé. Un mot de passe temporaire sera généré et envoyé par email. 
          L'associé pourra uniquement ajouter des ventes.
        </p>

        <form [formGroup]="associateForm" (ngSubmit)="onSubmitAssociate()">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">
                Email de l'associé <span class="text-red-400">*</span>
              </label>
              <input
                #associateEmailInput
                type="email"
                formControlName="email"
                [class.border-red-500]="isFieldInvalid('email')"
                class="w-full px-4 py-2 glass-effect-subtle border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:border-purple-400/50"
                placeholder="email@exemple.com"
              />
              @if (associateForm.get('email')?.invalid && associateForm.get('email')?.touched) {
                <p class="mt-1 text-sm text-red-400">
                  @if (associateForm.get('email')?.errors?.['required']) {
                    Ce champ est requis
                  } @else if (associateForm.get('email')?.errors?.['email']) {
                    Email invalide
                  }
                </p>
              }
            </div>
          </div>

          <div class="flex justify-end gap-4 mt-6">
            <button
              type="button"
              (click)="closeAssociateModal()"
              [disabled]="loading"
              class="px-6 py-2 border-2 border-white/30 text-white rounded-lg font-medium hover:bg-white/10 transition-colors disabled:opacity-50">
              Annuler
            </button>
            <button
              type="submit"
              [disabled]="loading || associateForm.invalid"
              class="px-6 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed">
              @if (loading) {
                <span class="flex items-center gap-2">
                  <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  Création...
                </span>
              } @else {
                Ajouter
              }
            </button>
          </div>
        </form>
      </app-glass-card>
    </div>
  }
</div>
