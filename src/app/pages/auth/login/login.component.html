<div class="auth-container" data-theme="liquidGlace">
  <div class="liquid-gradient fixed inset-0 -z-10"></div>
  <div class="fixed inset-0 -z-10 bg-gradient-to-br from-slate-900/90 via-purple-900/80 to-slate-900/90"></div>

  <div class="min-h-screen flex flex-col items-center justify-center px-4 py-12">
    <app-announcement-banner
      *ngIf="currentAnnouncement"
      [announcement]="currentAnnouncement"
      (closed)="onAnnouncementClosed()"
      class="w-full max-w-md mb-4"
    ></app-announcement-banner>
    <app-glass-card variant="strong" class="w-full max-w-md fade-in">
      <div class="p-8">
        <h1 class="text-3xl font-bold text-white mb-2 text-center">Connexion</h1>
        <p class="text-gray-300 text-center mb-8">Connectez-vous à votre compte Tamali</p>

        @if (error) {
          <div class="mb-6 p-4 bg-red-500/20 border border-red-500/50 rounded-lg text-red-200 text-sm">
            {{ error }}
          </div>
        }

        @if (step === 'email') {
          <form [formGroup]="loginForm" (ngSubmit)="onSubmitEmail()" class="space-y-6">
            <div>
              <label for="email" class="block text-sm font-medium text-gray-300 mb-2">
                Adresse email
              </label>
              <input
                id="email"
                type="email"
                formControlName="email"
                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                placeholder="votre@email.com"
                [class.border-red-500]="loginForm.get('email')?.invalid && loginForm.get('email')?.touched"
              />
              @if (loginForm.get('email')?.invalid && loginForm.get('email')?.touched) {
                <p class="mt-1 text-sm text-red-400">
                  @if (loginForm.get('email')?.errors?.['required']) {
                    L'email est requis
                  } @else if (loginForm.get('email')?.errors?.['email']) {
                    Email invalide
                  }
                </p>
              }
            </div>

            <button
              type="submit"
              [disabled]="loginForm.invalid || loading"
              class="w-full btn btn-primary glow-effect-hover py-3 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed"
            >
              @if (loading) {
                <span>Vérification...</span>
              } @else {
                <span>Continuer</span>
              }
            </button>
          </form>
        }

        @if (step === 'password') {
          <form [formGroup]="passwordForm" (ngSubmit)="onSubmitPassword()" class="space-y-6">
            <div>
              <label for="password" class="block text-sm font-medium text-gray-300 mb-2">
                Mot de passe
              </label>
              <input
                id="password"
                type="password"
                formControlName="password"
                class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                placeholder="••••••"
                [class.border-red-500]="passwordForm.get('password')?.invalid && passwordForm.get('password')?.touched"
              />
              @if (passwordForm.get('password')?.invalid && passwordForm.get('password')?.touched) {
                <p class="mt-1 text-sm text-red-400">
                  Le mot de passe est requis
                </p>
              }
            </div>

            <div class="flex gap-4">
              <button
                type="button"
                (click)="backToEmail()"
                class="flex-1 btn btn-outline border-white/20 text-white py-3 rounded-lg font-medium"
              >
                Retour
              </button>
              <button
                type="submit"
                [disabled]="passwordForm.invalid || loading"
                class="flex-1 btn btn-primary glow-effect-hover py-3 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed"
              >
                @if (loading) {
                  <span>Vérification...</span>
                } @else {
                  <span>Continuer</span>
                }
              </button>
            </div>
          </form>
        }

        @if (step === 'code') {
          <div class="space-y-6">
            <div class="text-center">
              <p class="text-gray-300 mb-2">Un code de vérification a été envoyé à</p>
              <p class="text-white font-medium">{{ userEmail }}</p>
            </div>

            <form [formGroup]="codeForm" class="space-y-6">
              <div>
                <label for="code" class="block text-sm font-medium text-gray-300 mb-2">
                  Code de vérification (6 chiffres)
                </label>
                <input
                  id="code"
                  type="text"
                  formControlName="code"
                  maxlength="6"
                  class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-center text-2xl tracking-widest font-mono"
                  placeholder="000000"
                  [class.border-red-500]="codeForm.get('code')?.invalid && codeForm.get('code')?.touched"
                  (input)="onCodeInput($event)"
                />
                @if (codeForm.get('code')?.invalid && codeForm.get('code')?.touched) {
                  <p class="mt-1 text-sm text-red-400">
                    @if (codeForm.get('code')?.errors?.['required']) {
                      Le code est requis
                    } @else if (codeForm.get('code')?.errors?.['pattern']) {
                      Le code doit contenir exactement 6 chiffres
                    }
                  </p>
                }
              </div>

              @if (loading) {
                <div class="text-center text-gray-400 text-sm">
                  Vérification en cours...
                </div>
              }

              <div class="flex gap-4">
                <button
                  type="button"
                  (click)="step = 'password'; codeForm.reset(); error = null;"
                  class="flex-1 btn btn-outline border-white/20 text-white py-3 rounded-lg font-medium"
                >
                  Retour
                </button>
                <button
                  type="button"
                  (click)="resendCode()"
                  [disabled]="resendCooldown > 0 || resendAttempts >= maxResendAttempts || loading"
                  class="flex-1 btn btn-secondary py-3 rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  @if (resendCooldown > 0) {
                    <span>Renvoyer ({{ resendCooldown }}s)</span>
                  } @else if (resendAttempts >= maxResendAttempts) {
                    <span>Limite atteinte</span>
                  } @else {
                    <span>Renvoyer le code</span>
                  }
                </button>
              </div>
            </form>
          </div>
        }

        <div class="mt-8 text-center">
          <p class="text-gray-400 text-sm">
            Vous n'avez pas de compte ?
            <a routerLink="/service-request" class="text-purple-400 hover:text-purple-300 font-medium">
              Demander l'accès
            </a>
          </p>
        </div>
      </div>
    </app-glass-card>
  </div>
</div>
